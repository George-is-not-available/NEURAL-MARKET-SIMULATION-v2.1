<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />
    <title>AI å¸‚åœºæ¨¡æ‹Ÿ - åœ°å›¾æ˜¾ç¤º</title>
    <style>
        html, body, #container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        .info-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            min-width: 250px;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
        
        .ai-status {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            border-left: 4px solid #00ff00;
        }
        
        .ai-status.trading { border-left-color: #0080ff; }
        .ai-status.thinking { border-left-color: #8000ff; }
        .ai-status.idle { border-left-color: #ffff00; }
        .ai-status.bankrupt { border-left-color: #ff0000; }
        
        .building-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            min-width: 200px;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
        
        .controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
        
        .btn {
            background: #25A5F7;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
        }
        
        .btn:hover {
            background: #1e8bc3;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 2000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <div class="loading" id="loading">æ­£åœ¨åŠ è½½åœ°å›¾å’ŒAIæ•°æ®...</div>
    
    <div class="info-panel">
        <h3>ğŸ¤– AI ä»£ç†çŠ¶æ€</h3>
        <div id="aiStatus"></div>
    </div>
    
    <div class="building-info">
        <h3>ğŸ¢ å»ºç­‘ç‰©ä¿¡æ¯</h3>
        <div id="buildingInfo">ç‚¹å‡»å»ºç­‘ç‰©æŸ¥çœ‹è¯¦æƒ…</div>
    </div>
    
    <div class="controls">
        <h3>ğŸ® æ§åˆ¶é¢æ¿</h3>
        <button class="btn" onclick="startSimulation()">å¼€å§‹æ¨¡æ‹Ÿ</button>
        <button class="btn" onclick="pauseSimulation()">æš‚åœ</button>
        <button class="btn" onclick="resetSimulation()">é‡ç½®</button>
        <br><br>
        <button class="btn" onclick="focusOnActivity()">æŸ¥çœ‹æ´»åŠ¨</button>
        <button class="btn" onclick="toggleBuildingLabels()">åˆ‡æ¢æ ‡ç­¾</button>
    </div>

    <!-- è®¾ç½®å®‰å…¨å¯†é’¥ -->
    <script>
        window._AMapSecurityConfig = {
            securityJSCode: 'cea99f47726c5e7712f7b851201866aa'
        };
    </script>

    <!-- åŠ è½½åœ°å›¾JSAPIè„šæœ¬ -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=ef3c3095b51b10259a39ac4216e81f1f"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        let map;
        let aiMarkers = [];
        let buildingMarkers = [];
        let simulationRunning = false;
        let showBuildingLabels = true;
        let socket;
        let serverUrl = 'http://localhost:3002';
        
        // AI ä»£ç†æ•°æ®ï¼ˆå°†ä»æœåŠ¡å™¨åŠ¨æ€åŠ è½½ï¼‰
        let aiAgents = [
            {
                id: 'ai1',
                name: 'Alex Chen (äº¤æ˜“å‘˜)',
                position: [116.397428, 39.90923],
                status: 'trading',
                balance: 125000,
                color: '#00ff00',
                currentBuilding: 'bank',
                activity: 'æ­£åœ¨é“¶è¡ŒåŠç†å¤§é¢è½¬è´¦'
            },
            {
                id: 'ai2',
                name: 'Sarah Kim (åˆ†æå¸ˆ)',
                position: [116.405285, 39.904989],
                status: 'thinking',
                balance: 89000,
                color: '#0080ff',
                currentBuilding: 'office',
                activity: 'åœ¨åŠå…¬æ¥¼åˆ†æå¸‚åœºæ•°æ®'
            },
            {
                id: 'ai3',
                name: 'David Wang (ç­–ç•¥å¸ˆ)',
                position: [116.395645, 39.913423],
                status: 'active',
                balance: 152000,
                color: '#8000ff',
                currentBuilding: 'hotel',
                activity: 'åœ¨é…’åº—ä¼šè®®å®¤åˆ¶å®šæŠ•èµ„ç­–ç•¥'
            },
            {
                id: 'ai4',
                name: 'Emily Zhang (è§‚å¯Ÿå‘˜)',
                position: [116.400000, 39.900000],
                status: 'idle',
                balance: 73000,
                color: '#ffff00',
                currentBuilding: 'mall',
                activity: 'åœ¨å•†åœºè§‚å¯Ÿæ¶ˆè´¹è€…è¡Œä¸º'
            }
        ];
        
        // å»ºç­‘ç‰©æ•°æ®ï¼ˆå°†ä»æœåŠ¡å™¨åŠ¨æ€åŠ è½½ï¼‰
        let buildings = [
            {
                id: 'bank',
                name: 'ä¸­å¤®é“¶è¡Œ',
                position: [116.397428, 39.90923],
                type: 'financial',
                description: 'æä¾›é‡‘èæœåŠ¡ï¼ŒAIå¯åœ¨æ­¤è¿›è¡Œè½¬è´¦ã€è´·æ¬¾ã€æŠ•èµ„ç­‰æ“ä½œ',
                activities: ['è½¬è´¦', 'è´·æ¬¾', 'æŠ•èµ„', 'å¤–æ±‡äº¤æ˜“']
            },
            {
                id: 'office',
                name: 'å•†åŠ¡åŠå…¬æ¥¼',
                position: [116.405285, 39.904989],
                type: 'business',
                description: 'å•†åŠ¡åŠå…¬åœºæ‰€ï¼ŒAIå¯è¿›è¡Œæ•°æ®åˆ†æã€ä¼šè®®ã€å†³ç­–ç­‰',
                activities: ['æ•°æ®åˆ†æ', 'å•†åŠ¡ä¼šè®®', 'ç­–ç•¥åˆ¶å®š', 'æŠ¥å‘Šæ’°å†™']
            },
            {
                id: 'hotel',
                name: 'å›½é™…é…’åº—',
                position: [116.395645, 39.913423],
                type: 'hospitality',
                description: 'é«˜çº§é…’åº—ï¼ŒAIå¯åœ¨æ­¤è¿›è¡Œå•†åŠ¡æ´½è°ˆã€ä¼‘æ¯ç­‰',
                activities: ['å•†åŠ¡æ´½è°ˆ', 'ç½‘ç»œä¼šè®®', 'ä¼‘æ¯è°ƒæ•´', 'ç¤¾äº¤æ´»åŠ¨']
            },
            {
                id: 'mall',
                name: 'è´­ç‰©ä¸­å¿ƒ',
                position: [116.400000, 39.900000],
                type: 'retail',
                description: 'å¤§å‹è´­ç‰©ä¸­å¿ƒï¼ŒAIå¯è§‚å¯Ÿæ¶ˆè´¹è¶‹åŠ¿ã€å¸‚åœºè°ƒç ”',
                activities: ['å¸‚åœºè°ƒç ”', 'æ¶ˆè´¹è§‚å¯Ÿ', 'è¶‹åŠ¿åˆ†æ', 'è´­ç‰©ä½“éªŒ']
            },
            {
                id: 'exchange',
                name: 'è¯åˆ¸äº¤æ˜“æ‰€',
                position: [116.410000, 39.920000],
                type: 'financial',
                description: 'è¯åˆ¸äº¤æ˜“æ‰€ï¼ŒAIè¿›è¡Œè‚¡ç¥¨äº¤æ˜“çš„ä¸»è¦åœºæ‰€',
                activities: ['è‚¡ç¥¨äº¤æ˜“', 'æœŸè´§äº¤æ˜“', 'å¸‚åœºç›‘æ§', 'é£é™©è¯„ä¼°']
            }
        ];
        
        // åˆå§‹åŒ–Socket.IOè¿æ¥
        function initSocket() {
            socket = io(serverUrl);
            
            socket.on('connect', () => {
                console.log('Connected to server');
                loadBuildingsFromServer();
                loadAIDataFromServer();
            });
            
            socket.on('aiEnterBuilding', (data) => {
                console.log('AI entered building:', data);
                updateAIStatus();
            });
            
            socket.on('aiLeaveBuilding', (data) => {
                console.log('AI left building:', data);
                updateAIStatus();
            });
            
            socket.on('aiStartActivity', (data) => {
                console.log('AI started activity:', data);
                updateAIStatus();
            });
            
            socket.on('aiCompleteActivity', (data) => {
                console.log('AI completed activity:', data);
                updateAIStatus();
            });
            
            socket.on('aiStartMovement', (data) => {
                console.log('AI started movement:', data);
                updateAIStatus();
            });
            
            socket.on('aiArriveBuilding', (data) => {
                console.log('AI arrived at building:', data);
                updateAIStatus();
            });
        }
        
        // ä»æœåŠ¡å™¨åŠ è½½å»ºç­‘ç‰©æ•°æ®
        async function loadBuildingsFromServer() {
            try {
                const response = await fetch(`${serverUrl}/api/buildings`);
                const result = await response.json();
                if (result.success) {
                    // æ›´æ–°å»ºç­‘ç‰©æ•°æ®
                    buildings.length = 0;
                    buildings.push(...result.data);
                    console.log('Loaded buildings from server:', buildings);
                    if (map) {
                        initBuildings();
                    }
                }
            } catch (error) {
                console.error('Failed to load buildings from server:', error);
            }
        }
        
        // ä»æœåŠ¡å™¨åŠ è½½AIæ•°æ®
        async function loadAIDataFromServer() {
            try {
                // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦ä»æœåŠ¡å™¨è·å–AIæ•°æ®
                // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                console.log('Using simulated AI data');
                if (map) {
                    initAIAgents();
                }
            } catch (error) {
                console.error('Failed to load AI data from server:', error);
            }
        }
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            document.getElementById('loading').style.display = 'block';
            
            map = new AMap.Map('container', {
                viewMode: '2D',
                zoom: 14,
                center: [116.397428, 39.90923],
                mapStyle: 'amap://styles/dark' // æš—è‰²ä¸»é¢˜
            });
            
            // åœ°å›¾åŠ è½½å®Œæˆåçš„å¤„ç†
            map.on('complete', function() {
                document.getElementById('loading').style.display = 'none';
                console.log('åœ°å›¾åŠ è½½å®Œæˆ');
                
                // åˆå§‹åŒ–Socketè¿æ¥
                initSocket();
            });
            
            // ç‚¹å‡»åœ°å›¾äº‹ä»¶
            map.on('click', function(e) {
                console.log('ç‚¹å‡»ä½ç½®:', e.lnglat.getLng(), e.lnglat.getLat());
            });
        }
        
        // åˆå§‹åŒ–å»ºç­‘ç‰©æ ‡è®°
        function initBuildings() {
            buildings.forEach(building => {
                // åˆ›å»ºå»ºç­‘ç‰©æ ‡è®°
                const marker = new AMap.Marker({
                    position: building.position,
                    title: building.name,
                    content: createBuildingMarkerContent(building),
                    offset: new AMap.Pixel(-12, -12)
                });
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                marker.on('click', function() {
                    showBuildingInfo(building);
                });
                
                map.add(marker);
                buildingMarkers.push(marker);
                
                // æ·»åŠ å»ºç­‘ç‰©æ ‡ç­¾
                if (showBuildingLabels) {
                    const label = new AMap.Text({
                        text: building.name,
                        position: building.position,
                        offset: new AMap.Pixel(0, -40),
                        style: {
                            'background-color': 'rgba(0,0,0,0.8)',
                            'border': '1px solid #ccc',
                            'color': 'white',
                            'font-size': '12px',
                            'padding': '4px 8px',
                            'border-radius': '4px'
                        }
                    });
                    map.add(label);
                }
            });
        }
        
        // åˆ›å»ºå»ºç­‘ç‰©æ ‡è®°å†…å®¹
        function createBuildingMarkerContent(building) {
            const icons = {
                'financial': 'ğŸ¦',
                'business': 'ğŸ¢',
                'hospitality': 'ğŸ¨',
                'retail': 'ğŸ¬'
            };
            
            return `<div style="
                width: 24px; 
                height: 24px; 
                background: rgba(0,0,0,0.8); 
                border: 2px solid #fff;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                cursor: pointer;
            ">${icons[building.type] || 'ğŸ¢'}</div>`;
        }
        
        // åˆå§‹åŒ–AIä»£ç†
        function initAIAgents() {
            aiAgents.forEach(agent => {
                const marker = new AMap.Marker({
                    position: agent.position,
                    title: agent.name,
                    content: createAIMarkerContent(agent),
                    offset: new AMap.Pixel(-15, -15)
                });
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                marker.on('click', function() {
                    showAIInfo(agent);
                });
                
                map.add(marker);
                aiMarkers.push({ marker, agent });
                
                // æ·»åŠ æ´»åŠ¨èŒƒå›´åœ†åœˆ
                const circle = new AMap.Circle({
                    center: agent.position,
                    radius: 100,
                    strokeColor: agent.color,
                    strokeOpacity: 0.5,
                    strokeWeight: 2,
                    fillColor: agent.color,
                    fillOpacity: 0.1
                });
                map.add(circle);
            });
        }
        
        // åˆ›å»ºAIæ ‡è®°å†…å®¹
        function createAIMarkerContent(agent) {
            const statusIcons = {
                'active': 'ğŸŸ¢',
                'trading': 'ğŸ”µ',
                'thinking': 'ğŸŸ£',
                'idle': 'ğŸŸ¡',
                'bankrupt': 'ğŸ”´'
            };
            
            return `<div style="
                width: 30px; 
                height: 30px; 
                background: ${agent.color}; 
                border: 3px solid #fff;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                box-shadow: 0 0 10px rgba(0,0,0,0.5);
                cursor: pointer;
                animation: pulse 2s infinite;
            ">${statusIcons[agent.status] || 'ğŸ¤–'}</div>`;
        }
        
        // æ›´æ–°AIçŠ¶æ€é¢æ¿
        function updateAIStatus() {
            const statusDiv = document.getElementById('aiStatus');
            statusDiv.innerHTML = aiAgents.map(agent => `
                <div class="ai-status ${agent.status}">
                    <strong>${agent.name}</strong><br>
                    çŠ¶æ€: ${getStatusText(agent.status)}<br>
                    ä½™é¢: Â¥${agent.balance.toLocaleString()}<br>
                    ä½ç½®: ${getBuildingName(agent.currentBuilding)}<br>
                    æ´»åŠ¨: ${agent.activity}
                </div>
            `).join('');
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'active': 'æ´»è·ƒ',
                'trading': 'äº¤æ˜“ä¸­',
                'thinking': 'æ€è€ƒä¸­',
                'idle': 'ç©ºé—²',
                'bankrupt': 'ç ´äº§'
            };
            return statusMap[status] || 'æœªçŸ¥';
        }
        
        // è·å–å»ºç­‘ç‰©åç§°
        function getBuildingName(buildingId) {
            const building = buildings.find(b => b.id === buildingId);
            return building ? building.name : 'æœªçŸ¥ä½ç½®';
        }
        
        // æ˜¾ç¤ºå»ºç­‘ç‰©ä¿¡æ¯
        function showBuildingInfo(building) {
            const infoDiv = document.getElementById('buildingInfo');
            const aiInBuilding = aiAgents.filter(agent => agent.currentBuilding === building.id);
            
            infoDiv.innerHTML = `
                <h4>${building.name}</h4>
                <p><strong>ç±»å‹:</strong> ${building.type}</p>
                <p><strong>æè¿°:</strong> ${building.description}</p>
                <p><strong>å¯ç”¨æ´»åŠ¨:</strong> ${building.activities.join(', ')}</p>
                <p><strong>å½“å‰AI:</strong> ${aiInBuilding.length > 0 ? aiInBuilding.map(a => a.name).join(', ') : 'æ— '}</p>
            `;
        }
        
        // æ˜¾ç¤ºAIä¿¡æ¯
        function showAIInfo(agent) {
            const building = buildings.find(b => b.id === agent.currentBuilding);
            const infoWindow = new AMap.InfoWindow({
                content: `
                    <div style="padding: 10px; min-width: 200px;">
                        <h3>${agent.name}</h3>
                        <p><strong>çŠ¶æ€:</strong> ${getStatusText(agent.status)}</p>
                        <p><strong>ä½™é¢:</strong> Â¥${agent.balance.toLocaleString()}</p>
                        <p><strong>å½“å‰ä½ç½®:</strong> ${building ? building.name : 'æœªçŸ¥'}</p>
                        <p><strong>å½“å‰æ´»åŠ¨:</strong> ${agent.activity}</p>
                        <p><strong>ä½ç½®åæ ‡:</strong> ${agent.position[0].toFixed(6)}, ${agent.position[1].toFixed(6)}</p>
                    </div>
                `,
                offset: new AMap.Pixel(0, -30)
            });
            infoWindow.open(map, agent.position);
        }
        
        // æ¨¡æ‹Ÿæ§åˆ¶å‡½æ•°
        function startSimulation() {
            simulationRunning = true;
            console.log('å¼€å§‹æ¨¡æ‹Ÿ');
            
            // é€šè¿‡APIå¯åŠ¨æ¨¡æ‹Ÿ
            fetch(`${serverUrl}/api/simulation/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Simulation started:', data);
            })
            .catch(error => {
                console.error('Failed to start simulation:', error);
            });
        }
        
        function pauseSimulation() {
            simulationRunning = false;
            console.log('æš‚åœæ¨¡æ‹Ÿ');
            
            // é€šè¿‡APIæš‚åœæ¨¡æ‹Ÿ
            fetch(`${serverUrl}/api/simulation/pause`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Simulation paused:', data);
            })
            .catch(error => {
                console.error('Failed to pause simulation:', error);
            });
        }
        
        function resetSimulation() {
            simulationRunning = false;
            console.log('é‡ç½®æ¨¡æ‹Ÿ');
            
            // é€šè¿‡APIé‡ç½®æ¨¡æ‹Ÿ
            fetch(`${serverUrl}/api/simulation/reset`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Simulation reset:', data);
                // é‡ç½®AIçŠ¶æ€
                aiAgents.forEach(agent => {
                    agent.status = 'idle';
                    agent.balance = 100000;
                });
                updateAIStatus();
            })
            .catch(error => {
                console.error('Failed to reset simulation:', error);
            });
        }
        
        // æ¨¡æ‹ŸAIæ´»åŠ¨
        function simulateAIActivity() {
            if (!simulationRunning) return;
            
            aiAgents.forEach(agent => {
                // éšæœºæ”¹å˜çŠ¶æ€
                const statuses = ['active', 'trading', 'thinking', 'idle'];
                agent.status = statuses[Math.floor(Math.random() * statuses.length)];
                
                // éšæœºæ”¹å˜ä½™é¢
                agent.balance += Math.floor((Math.random() - 0.5) * 10000);
                agent.balance = Math.max(0, agent.balance);
                
                // éšæœºæ”¹å˜æ´»åŠ¨
                const building = buildings.find(b => b.id === agent.currentBuilding);
                if (building) {
                    agent.activity = building.activities[Math.floor(Math.random() * building.activities.length)];
                }
            });
            
            updateAIStatus();
        }
        
        // èšç„¦åˆ°æ´»åŠ¨
        function focusOnActivity() {
            const activeAgent = aiAgents.find(agent => agent.status === 'trading' || agent.status === 'active');
            if (activeAgent) {
                map.setCenter(activeAgent.position);
                map.setZoom(16);
                showAIInfo(activeAgent);
            }
        }
        
        // åˆ‡æ¢å»ºç­‘ç‰©æ ‡ç­¾
        function toggleBuildingLabels() {
            showBuildingLabels = !showBuildingLabels;
            // é‡æ–°åˆå§‹åŒ–å»ºç­‘ç‰©ï¼ˆç®€å•å®ç°ï¼‰
            map.clearMap();
            initBuildings();
            initAIAgents();
        }
        
        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);
        
        // åˆå§‹åŒ–åœ°å›¾
        initMap();
        
        // å®šæœŸæ›´æ–°AIçŠ¶æ€
        setInterval(async () => {
            if (socket && socket.connected) {
                try {
                    const response = await fetch(`${serverUrl}/api/statistics`);
                    const result = await response.json();
                    if (result.success) {
                        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                        console.log('Statistics updated:', result.data);
                    }
                } catch (error) {
                    console.error('Failed to update statistics:', error);
                }
            }
        }, 5000);
        
    </script>
</body>
</html>